<!DOCTYPE html>
<html lang="ko-ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>JPA OneToMany 필드의 StackOverflowError - 꿀테크 블로그</title>
  <meta property="og:title" content="JPA OneToMany 필드의 StackOverflowError - 꿀테크 블로그" />
  <meta name="twitter:title" content="JPA OneToMany 필드의 StackOverflowError - 꿀테크 블로그" />
  <meta name="description" content="JPA OneToMany 필드 타입을 Set으로 설정할 경우 stackoverflow 발생하는 문제 해결법">
  <meta property="og:description" content="JPA OneToMany 필드 타입을 Set으로 설정할 경우 stackoverflow 발생하는 문제 해결법">
  <meta name="twitter:description" content="JPA OneToMany 필드 타입을 Set으로 설정할 경우 stackoverflow 발생하는 문제 해결법">
  <meta name="author" content="YeongCheon Kim"/>
  <meta property="og:site_name" content="꿀테크 블로그" />
  <meta property="og:url" content="https://yeongcheon.github.io/posts/2019-11-14-jpa-one-to-many-collection-set/" />
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://yeongcheon.github.io/images/profile.png" />
  <meta name="twitter:image" content="https://yeongcheon.github.io/images/profile.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.69.0" />

  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />

  <script src="/js/script.js"></script>
  <script src="/js/custom.js"></script>
  <script defer src="/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">꿀테크 블로그</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-tags"><a href="/tags/" title="Tags">Tags</a></li>
      <li class="site-navi-item-archives"><a href="/posts/" title="Archives">Archives</a></li>
      <li class="site-navi-item-about"><a href="/about/" title="About">About</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">JPA OneToMany 필드의 StackOverflowError</h1>
      <h2 class="article-subtitle">JPA OneToMany 필드 타입을 Set으로 설정할 경우 stackoverflow 발생하는 문제 해결법</h2>
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>November 25, 2019</time></li>
        <li class="article-meta-tags">
          <a href="/tags/jpa/">
            <i class="fas fa-tag"></i>
            JPA
          </a>&nbsp;
        </li>
        <li class="article-meta-tags">
          <a href="/tags/hibernate/">
            <i class="fas fa-tag"></i>
            hibernate
          </a>&nbsp;
        </li>
        <li class="article-meta-tags">
          <a href="/tags/kotlin/">
            <i class="fas fa-tag"></i>
            kotlin
          </a>&nbsp;
        </li>
      </ul>
      
<aside class="toc">
  <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">에러 발생 시나리오</a>
<ul>
<li><a href="#headline-2">구현 목표</a>
</li>
<li><a href="#headline-3">에러 발생 조건</a>
</li>
</ul>
</li>
<li><a href="#headline-4">Entity Model code</a>
<ul>
<li><a href="#headline-5">Parent.kt</a>
</li>
<li><a href="#headline-6">Child.kt</a>
</li>
</ul>
</li>
<li><a href="#headline-7">원인 파악</a>
</li>
<li><a href="#headline-8">해결법</a>
<ul>
<li><a href="#headline-9">Child.kt</a>
</li>
</ul>
</li>
</ul>
</nav>
</aside>
      
<p>
JPA를 사용하다 보면 StackOverflow 에러를 종종 만날 수 있다. 이 글에서는 필드 타입이 <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/-set/index.html">Set</a>인 Collection 타입에 아이템을 추가할 경우 StackVoerflow 에러가 발생하는 원인과 그 해결법에 대해 알아보자.
</p>
<p>
`hashcode`, `equals` 메서드와 관계된 이야기이다.
</p>
<h2 id="headline-1">
에러 발생 시나리오
</h2>
<h3 id="headline-2">
구현 목표
</h3>
<p>
부모객체와 자식객체들을 서버 데이터베이스에 저장하는 기능을 가진 코드가 있었다. 부모객체와 자식객체는 1:n관계로서 하나의 부모가 여러 개의 자식을 가질 수 있고 이 두 객체는 서로의 존재를 알고 있는 양방향 관계다. 이 관계를 OneToMany를 이용해서 표현하고 있었는데 이 때 사용하고 있던 Collecion 타입이 리스트(List)였다. 근데 여기저기 인터넷을 뒤지다 보니 OneToMany는 List보단 Set을 사용하는게 좋다는 글을 보게 되었고(<a href="https://jojoldu.tistory.com/165">링크</a>) 이 글이 추천하는 방법대로 Entity Model을 바꿔보기로 했다.
</p>
<h3 id="headline-3">
에러 발생 조건
</h3>
<p>
수정 자체는 그리 어렵지 않았다. 그냥 List 타입을 Set으로 바꿔주면 끝날줄 알았다(<del>뭔가를 변경할때는 방심하지 말자</del>).
</p>
<p>
 수정 후 테스트를 해보았다. 
</p>
<ul>
<li>
<p>
부모만 단독으로 추가할 경우 성공
</p>
</li>
<li>
<p>
부모객체 하나에 자식객체 하나를 추가할 경우 성공
</p>
</li>
<li>
<p>
<strong>부모객체 하나에 2개 이상의 자식 객체를 담아서 추가할 경우 실패</strong> - StackOverFlowError 발생
</p>
</li>
</ul>
<p>
비즈니스 로직 코드는 원래 문제가 없었으니 이번에 수정한 Entity Model 관련 코드를 살펴보자.
</p>
<h2 id="headline-4">
Entity Model code
</h2>
<h3 id="headline-5">
Parent.kt
</h3>
<div class="src src-kotlin">
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">@Entity
@Table(name = <span style="color:#e6db74">&#34;parent&#34;</span>)
<span style="color:#66d9ef">data</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Parent</span>(
   @get:Id
   @get:GeneratedValue(strategy = GenerationType.IDENTITY)
   <span style="color:#66d9ef">var</span> id: Long,

   @get:OneToMany(mappedBy = <span style="color:#e6db74">&#34;parent&#34;</span>)
   <span style="color:#66d9ef">var</span> childs: MutableSet&lt;Child&gt; <span style="color:#75715e">// 이 부분이 MutableList에서 MutableSet으로 변경되었다.
</span><span style="color:#75715e"></span>) {}</code></pre></td></tr></table>
</div>
</div>
</div>
<h3 id="headline-6">
Child.kt
</h3>
<div class="src src-kotlin">
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">@Entity
@Table(name = <span style="color:#e6db74">&#34;child&#34;</span>)
<span style="color:#66d9ef">data</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Child</span>(
   @get:Id
   @get:GeneratedValue(strategy = GenerationType.IDENTITY)
   <span style="color:#66d9ef">var</span> id: Long,

   @get:ManyToOne(cascade = [CascadeType.DETACH], fetch = FetchType.LAZY)
   @get:JoinColumn(name = <span style="color:#e6db74">&#34;parent_id&#34;</span>)
   <span style="color:#66d9ef">var</span> parent: Parent
) {}</code></pre></td></tr></table>
</div>
</div>
</div>
<h2 id="headline-7">
원인 파악
</h2>
<p>
  우선 발생하는 에러는 순환 참조로 인해 발생한 에러로 JPA를 사용하다 보면 제법 자주 만나볼 수 있는 에러다. 자세한 내용은 구글에 <a href="https://www.google.com/search?newwindow=1&amp;sxsrf=ACYBGNRvc-j9wUzYmyxwQeA9hKkEnp7H1g%253A1574606204506&amp;source=hp&amp;ei=fJXaXdnWHNv6-QbcsqrgBw&amp;q=jpa+%25EC%2596%2591%25EB%25B0%25A9%25ED%2596%25A5+%25EC%2588%259C%25ED%2599%2598%25EC%25B0%25B8%25EC%25A1%25B0&amp;oq=jpa+%25EC%2588%259C%25ED%2599%2598&amp;gs_l=psy-ab.3.1.0j0i8i30.1581.4291..5790...1.0..0.152.1185.3j8......0....1..gws-wiz.......0i3j0i131j35i39.msmwejOXyx0">JPA 양방향 순환참조</a>를 검색해보자.
</p>
<p>
  기존에 잘 돌아가던 기능이었는데 Collection을 List -&gt; Set으로 바꿨다고 갑자기 발생하는 이유가 뭘까? List와 Set에 대해서 간략하게 알아보자. JPA(hibernate) 내부에서 어떻게 동작하는지는 <a href="http://wonwoo.ml/index.php/post/992">다른 글</a>에서 알아보고 이번 글에서는 각 Collection 타입의 특징을 몇개 짚어보자.
</p>
<ul>
<li>
<p>
List Collection
</p>
<ul>
<li>
<p>
순서가 있는 데이터의 모임
</p>
</li>
<li>
<p>
<strong>중복을 허용한다.</strong>
</p>
</li>
<li>
<p>
대표적으로 ArrayList 와 LinkedList 가 있다.
</p>
</li>
</ul>
</li>
<li>
<p>
Set Collection
</p>
<ul>
<li>
<p>
순서가 없는 데이터의 모임(구현체에 따라 순서가 있는 경우도 있다.)
</p>
</li>
<li>
<p>
<strong>중복을 허용하지 않는다.</strong>
</p>
</li>
<li>
<p>
대표적으로 HashSet 이 있다.
</p>
</li>
</ul>
</li>
</ul>
<p>
이 중에서 우리가 주목해야 할 특징은 중복 여부이다. 앞서 테스트 케이스에서 성공 케이스와 실패 케이스를 살펴보면 자식객체가 2개 이상일 경우에만 에러가 발생했는데 이 때 코드가 동작하는 순서는 아래와 같다.
</p>
<ol>
<li>
<p>
Parent 객체를 생성한다.
</p>
</li>
<li>
<p>
Parent 객체에 종속된 Child 객체를 생성해서 Parent.childs(MutableSet) 필드에 추가한다.
</p>
</li>
<li>
<p>
Child 객체를 하나 더 생성해서 마찬가지로 Parent.childs 필드에 추가한다.
</p>
</li>
<li>
<p>
이 때 childs 필드에 이미 객체가 존재하므로 추가하려는 객체와 동일한 객체인지 확인한다. - <strong>이 때 에러 발생</strong>
</p>
</li>
<li>
<p>
동일한 객체가 아닐 경우 Parent.childs 필드에 객체를 추가한다.
</p>
</li>
</ol>
<p>
동일한 객체인지 판단할때 에러가 발생하는 이유를 알고자 하면 우선 Set Collection이 중복 체크를 어떻게 하는지 알아야 한다.
</p>
<p>
  자바 계열의 언어에선 <a href="https://opentutorials.org/module/516/6241">모든 객체가 Object class를 상속받은 채로 생성된다</a>(최상위 클래스). 이 Object 클래스에는 <a href="https://nesoy.github.io/articles/2018-06/Java-equals-hashcode">equals, hashcode</a> 메서드가 구현되어 있는데 Set Collection이 객체의 중복 여부를 체크할 때 이 두 메서드를 사용해서 중복 여부를 판단한다. 즉, Child 객체의 중복여부를 판단하기 위해서 Child 객체의 모든 필드값을 다 읽는 작업을 하게 되는데 이 때 Child.parent -&gt; Parent.childs -&gt; Child.parent -&gt; Parent.childs … 와 같은 순환참조 에러가 발생하게 된다.
</p>
<h2 id="headline-8">
해결법
</h2>
<p>
equals, hashcode 메서드 호출 중 에러가 발생하므로 이 두 메서드를 오버라이딩 해주면 해결할 수 있다. Parent는 건드릴 필요 없고 Child만 재정의 해주면 되는데 설명은 그만하고 수정된 코드를 보자.
</p>
<h3 id="headline-9">
Child.kt
</h3>
<div class="src src-kotlin">
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">@Entity
@Table(name = <span style="color:#e6db74">&#34;child&#34;</span>)
<span style="color:#66d9ef">data</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Child</span>(
   @get:Id
   @get:GeneratedValue(strategy = GenerationType.IDENTITY)
   <span style="color:#66d9ef">var</span> id: Long,

   @get:ManyToOne(cascade = [CascadeType.DETACH], fetch = FetchType.LAZY)
   @get:JoinColumn(name = <span style="color:#e6db74">&#34;parent_id&#34;</span>)
   <span style="color:#66d9ef">var</span> parent: Parent
) {
   <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">equals</span>(other: Any?): Boolean {
       <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.id == (other <span style="color:#66d9ef">as</span> SponsorshipGoalModel).id
   }

   <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">hashCode</span>(): Int {
       <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.id.hashCode()
   }
}</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  데이터베이스 기준으로 생각해보면 어차피 id 필드가 기본키로 설정되어 있기 때문에 id 필드만 중복되지 않으면 서로 다른 객체로 판단해도 문제가 없을거라고 판단했기에 id 필드만 체크하도록 수정해줬고 이 후에는 순환참조에러 없이 잘 동작한다.
</p>

    </article>

    

    <div class="disqus-comments">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yeongcheon" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

    <ul class="pager article-pager">
      <li class="pager-newer">
          <a href="/posts/2020-01-08-emacs-path-setting/" data-toggle="tooltip" data-placement="top" title="emacs에 $PATH 환경변수 인식 시키기">&lt; Newer</a>
      </li>
      <li class="pager-older">
        <a href="/posts/2019-08-05-intellij-appengine-error/" data-toggle="tooltip" data-placement="top" title="IntelliJ 업데이트 후 appengine local 실행 이슈 해결하기">Older &gt;</a>
      </li>
    </ul>
  </div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2019 YeongCheon</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-about"><a href="/about/" title="About">About</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a> and <a href="https://github.com/taikii/whiteplain">Whiteplain</a>
  </div>
</div>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-135478508-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
<script data-ad-client="ca-pub-4599234083355765" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</html>
