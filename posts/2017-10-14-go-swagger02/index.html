<!doctype html>
<html>
  <head>
    <title>go swagger 서버파일 구조 분석 // YeongCheon Tech Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.54.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="YeongCheon Kim" />
    <meta name="description" content="" />
    <base href="http://yeongcheon.github.io/" />
    <link rel="stylesheet" href="http://yeongcheon.github.io/css/main.min.3bf813d46763420c83fb33c51950b4fc582483efcfddb34b4e4e8d6b811e3208.css" />
  </head>
  <body>
    <header class="app-header">
      <a href="/"><img class="app-header-avatar" src="./avatar.jpg" /></a>
      <h1>YeongCheon Tech Blog</h1>
      <p>잡탕 웹개발자, 이맥스를 좋아해요</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/yeongcheon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">go swagger 서버파일 구조 분석</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Oct 14, 2017
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          4 min read
        </div></div>
    </header>
    <div class="post-content">
      

<h1 id="intro">Intro</h1>

<hr />

<p><a href="http://yeongcheon.github.io/2017/10/06/go-swagger01/">지난번 포스트</a>에서 만든 hello world 프로젝트의 구성요소들을 분석해보자.</p>

<h1 id="폴더-구조">폴더 구조</h1>

<hr />
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tree" data-lang="tree">├── cmd
│   └── helloworld-server
│         └── main.go
├── github.com
├── golang.org
├── gopkg.in
├── models
│    └── item.go
├── restapi
│    ├── configure_helloworld.go
│    ├── doc.go
│    ├── embedded_spec.go
│    ├── operations
│    │   ├── get.go
│    │   ├── get_parameters.go
│    │   ├── get_responses.go
│    │   ├── get_urlbuilder.go
│    │   └── helloworld_api.go
│    └── server.go
└── swagger.yml</code></pre></div>
<p><a href="http://yeongcheon.github.io/2017/10/06/go-swagger01/">지난번 포스트</a>를 처음부터 끝까지 다 따라했다면 <code>$GOPATH/src</code> 폴더가 위와 같은 구조로 이루어져 있을 것이다. 위의 구조에서 <code>swagger generate server</code> 명령어로 인해 생긴 폴더는 <code>cmd</code>, <code>models</code>, <code>restapi</code> 이렇게 세 개로 구성되어 있으며 이번에 주로 살펴볼 폴더들이다. 나머지 폴더들은 <code>go get</code> 명령어로 인해 생성된 외부 라이브러리 관련 폴더들이다.</p>

<h2 id="cmd">cmd</h2>

<hr />

<p>서버를 실행시킬 때 사용하는 파일이 들어있다. 지난번 포스트에서 서버를 실행시킬 때 사용했던 명령어는 아래와 같다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-command" data-lang="command">go run cmd/helloworld-server/main.go --port=9000 --host=127.0.0.1 --socket-path=/tmp/helloworld.sock --scheme=http</code></pre></div>
<p>구성요소들은 상당히 간소하다. <code>helloworld-server</code> 폴더 아래에 <code>main.go</code> 파일이 전부이다. 여기서 <code>helloworld-server</code>는 해당 프로젝트의 이름으로 <code>go generate</code> 명령어를 사용할 때 <code>-A</code> 옵션을 이용해 지정할 수 있다. 아래의 명령어는 지난 포스트에서 사용했던 명령어이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-command" data-lang="command">swagger generate server -A helloworld -f ./swagger.yml</code></pre></div>
<p>cmd 폴더 아래의 내용들은 사실 서버를 실행시키기 위한 파일에 불과할 뿐 우리가 <code>swagger.yml</code>에 선언한 내용들이 거의 들어가 있지 않다. 실제 프로그램 구동에 크게 영향을 미치는 파일들은 <code>restapi</code>, <code>models</code> 폴더에 들어있다.</p>

<h2 id="models">models</h2>

<hr />

<p><code>models</code> 폴더는 <code>swagger.yml</code> 파일에서 <code>definitions</code> 하위에 선언했었던 객체 모델을 코드로 구현해놓은 곳이다. <a href="https://opentutorials.org/course/697/3828">MVC 패턴</a>의 M에 해당한다고 생각하면 된다. 그래서 폴더 이름이 models인 것이다. 이 예제에선 <code>item.go</code> 파일이 구현되어 있다. <code>item.go</code> 는 파일명부터 내용까지 다 철처하게 <code>swagger.yml</code> 파일을 반영해서 생성된 것이다. 아래의 코드는 <code>swagger.yml</code>에서 <code>item.go</code> 파일을 정의한 내용이다. 이 내용은 <code>swagger.yml</code>의 <code>definitions</code> 아래에 작성되어 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  item:
    type: object
    required:
      - result
    properties:
      result:
        type: string</code></pre></div>
<p>첫번째 줄의 <code>item</code>이 모델명, 즉 <code>item.go</code> 파일 이름이 item인 이유다. item 대신 user를 쓰면 생성된 파일은 user.go가 될 것이다. 두번째 줄은 type의 종류를 선언하는 영역인데 모델은 대부분 여러개의 필드를 가지고 있기 때문에 object로 선언한다. 만약 여러개 속성없이 단순 문자열만 반환한다면 string으로 선언해도 무방할 것이다(실험을 안해봐서 확실하지 않다).</p>

<p>세번째 줄의 <code>required</code>는 이 모델의 속성에서 필수로 입력해야 되는 속성들을 선언하는 영역이다. 이번 예제에서는 <code>result</code> 필드를 필수로 하겠다고 선언되어 있다.</p>

<p><code>properties</code>는 이 모델이 가지고 있는 속성들을 작성하는 곳이다. 이번 예제에서는 <code>result</code> 하나만 사용했지만 여러개를 추가할 수 있다. 이름도 얼마든지 마음대로 선언할 수 있다(프로그램 변수선언 규칙 내에서).</p>

<p>아래의 코드는 위의 코드를 확장에서 <code>user</code> 모델을 추가로 선언하는 <code>swagger.yml</code> 코드의 <code>definitions</code> 관련 구문이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">definitions:
  item:
    type: object
    required:
      - result
    properties:
      result:
        type: string
  user:
    type: object
    required:
      - id
    properties:
      id:
        type: string
      name:
        type: string
      email:
        type: string</code></pre></div>
<p>위 코드가 포함된 <code>swagger.yml</code>파일을 사용해 <code>go generate</code> 명령어를 수행하면 <code>models</code> 폴더 아래에 <code>user.go</code>, <code>model.go</code> 파일이 각각 생성되어 있을 것이다. 그리고 models 관련 내용 중 가장 주의해야 할 점은  <strong>models 폴더 아래의 파일들은 직접 수정하면 안된다!</strong> 코드를 까보면 알겠지만 소스파일 최상단에 코드를 수정하지 말라는 경고주석이 작성되어 있다. 이러한 경고가 있는 이유는 크게 두가지가 있다.</p>

<p>첫번째. <code>swagger.yml</code> 파일을 수정하고 다시 <code>swagger generate</code> 명령을 수행할 경우 models 폴더의 모든 내용은 swagger가 덮어씌우기 때문이다. 따라서 만약 <code>models</code> 폴더의  내용을 바꾸고 싶다면 <code>swagger.yml</code> 파일을 수정하고 다시 <code>swagger ganerate</code> 명령어를 실행하여야 한다. 물론 안의 코드를 직접 수정해도 제대로 수정만 한다면 프로그램은 문제없이 돌아간다. <strong>하지만 <code>swagger.yml</code>을 업데이트 해야 할 경우는 반드시 생긴다. 절대 직접 수정하는 일은 없도록 하자.</strong></p>

<p>두번째. 코드의 내용이 문서와 달라질 가능성이 생긴다. <strong>우리가 swagger를 쓰는 목적은 REST API 문서를 자동으로 생성하기 위해서이다.</strong> swagger는 <code>swagger.yml</code>의 내용을 기반으로 spec을 생성, 이 spec이 곧 문서가 된다. 그리고 swagger는 코드의 변경내용을 파악하지 못한다. 근데 <code>swagger.yml</code>을 수정하지 않고 직접 코드를 수정할 경우 우리가 추후 생성할 문서에는 나타나지 않는 변경점이 코드에 반영될 수 있다. <strong>우리가 코드에 직접 작성해야 할 내용은 오직 로직뿐이다.</strong> 모델, Path 등등은 직접 코드로 작성하지 않도록 하자.</p>

<h2 id="restapi">restapi</h2>

<hr />

<p>Handler, 즉 MVC 패턴의 C에 해당하는 부분이다. <code>swagger generate</code> 명령어로 생성된 대부분의 파일은 개발자가 코드를 직접 수정하는걸 금지하한다. 하지만 이 폴더의 <strong><code>configure_helloworld.go</code>는 우리가 직접 수정할 수 있다.</strong> 사실상 우리가 건드려도 되는 <strong>유일한 파일</strong>인데  실제 비즈니스 로직을 여기에 작성하면 된다. <code>configure_helloworld.go</code> 파일을 살펴보면 다음과 같은 주석이 달려있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#f92672">//</span> <span style="color:#a6e22e">This</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">safe</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">edit</span>. <span style="color:#a6e22e">Once</span> <span style="color:#a6e22e">it</span> <span style="color:#a6e22e">exists</span> <span style="color:#a6e22e">it</span> <span style="color:#a6e22e">will</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">be</span> <span style="color:#a6e22e">overwritten</span></code></pre></div>
<p>위 주석은 <code>swagger generate</code> 명령어를 여러번 실행해도 이 파일은 덮어씌워지지 않는다는 소리다. 사실 프로그램을 구현하려면 이 파일을 수정할 수 밖에 없는 구조인데 swagger.yml을 업데이트 하고 <code>swagger generate</code> 명령어를 실행할 때마다 이 파일이 덮어씌워진다면 제대로 프로젝트 진행하기가 상당히 까다로울 것이다. 그리고 <strong>이 파일을 수정할 수 밖에 없는 이유는 이 파일의 코드에 선언된 모든 Handler가 <code>NotImplemented error</code>를 반환하기 때문이다.</strong> <a href="http://yeongcheon.github.io/2017/10/06/go-swagger01/">지난번 포스트</a>에서도 <code>NotImplemented error</code> 코드를 주석처리하고 실제 원하는 결과를 출력하도록 코드를 수정하는 내용이 있다.</p>

<p>restapi 폴더에선 <code>configure_helloworld.go</code> 파일이 핵심이라 다른 파일들에 대한 얘기가 너무 소홀했는데 간단하게 말하자면 아래와 같다. <del>사실 몰라도 된다.</del>
* doc.go : <code>swagger.yml</code> 에서 선언한 프로젝트명, 호스트, 기본경로 등등 프로젝트의 기초가 되는 정보들을 가지고 있는 파일이다. godoc에서 쓰라고 만든 파일인 것 같다.
* embedded_spec.go : <code>swagger.yml</code> 파일을 json 형식으로 변환한 spec을 가지고 있는 파일이다.
* opertaions 폴더 : REST API 프로그램에 필요한 필수사항들(파라메터 처리, Method 별 분기처리, 기타 등등..)을 구현한 코드. 예제에서는 GET Method만 사용하지 때문에 GET 관련 파일들만 보이지만 추가로 POST, PUT, DELETE Method를 사용할 경우 파일이 추가 생성된다(확실하지 않음).</p>

<h1 id="한줄-요약">한줄 요약</h1>

<p><strong><code>configure_helloworld.go</code> 파일을 제외한 다른 파일들은 직접 수정하지 말고 <code>swagger.yml</code>을 수정하여 <code>swagger generate</code> 명령어를 이용하자.</strong></p>

    </div>
  </article>

    </main>
  </body>
</html>
