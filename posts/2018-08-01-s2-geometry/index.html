<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>YeongCheon Blog  | S2 library를 이용하여 가까운 위치의 사용자 찾기</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.955516233bcafa4d2a1c13cea63c7b50.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="S2 library를 이용하여 가까운 위치의 사용자 찾기" />
<meta property="og:description" content="구글에서 제공하는 S2 라이브러리를 이용하여 현재 내 위치에서 가장 가까운 사용자 목록을 추출해보자. 서버 환경은 GAE, golang standard environment 이다. 이 글을 참고했다.
S2 라이브러리란? S2 라이브러리는 구글에서 비공식적으로(not an official) 제공하는 구(球)형상 라이브러리이다(번역기 발췌). 기존의 대다수 라이브러리는 2차원 평면을 기준으로 좌표시스템을 구축하였지만 S2 라이브러리는 3차원 구를 기준으로 좌표계를 사용한다. 실제 지구는 평면보단 구(球)에 훨씬 가깝기 때문에 좀 더 정교하고 왜곡없는 지리 데이터베이스를 구축할 수 있다(이 역시 번역기 발췌)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://yeongcheon.github.io/posts/2018-08-01-s2-geometry/" />
<meta property="article:published_time" content="2018-08-05T18:00:00&#43;09:00"/>
<meta property="article:modified_time" content="2018-08-05T18:00:00&#43;09:00"/>

<meta itemprop="name" content="S2 library를 이용하여 가까운 위치의 사용자 찾기">
<meta itemprop="description" content="구글에서 제공하는 S2 라이브러리를 이용하여 현재 내 위치에서 가장 가까운 사용자 목록을 추출해보자. 서버 환경은 GAE, golang standard environment 이다. 이 글을 참고했다.
S2 라이브러리란? S2 라이브러리는 구글에서 비공식적으로(not an official) 제공하는 구(球)형상 라이브러리이다(번역기 발췌). 기존의 대다수 라이브러리는 2차원 평면을 기준으로 좌표시스템을 구축하였지만 S2 라이브러리는 3차원 구를 기준으로 좌표계를 사용한다. 실제 지구는 평면보단 구(球)에 훨씬 가깝기 때문에 좀 더 정교하고 왜곡없는 지리 데이터베이스를 구축할 수 있다(이 역시 번역기 발췌).">


<meta itemprop="datePublished" content="2018-08-05T18:00:00&#43;09:00" />
<meta itemprop="dateModified" content="2018-08-05T18:00:00&#43;09:00" />
<meta itemprop="wordCount" content="602">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="S2 library를 이용하여 가까운 위치의 사용자 찾기"/>
<meta name="twitter:description" content="구글에서 제공하는 S2 라이브러리를 이용하여 현재 내 위치에서 가장 가까운 사용자 목록을 추출해보자. 서버 환경은 GAE, golang standard environment 이다. 이 글을 참고했다.
S2 라이브러리란? S2 라이브러리는 구글에서 비공식적으로(not an official) 제공하는 구(球)형상 라이브러리이다(번역기 발췌). 기존의 대다수 라이브러리는 2차원 평면을 기준으로 좌표시스템을 구축하였지만 S2 라이브러리는 3차원 구를 기준으로 좌표계를 사용한다. 실제 지구는 평면보단 구(球)에 훨씬 가깝기 때문에 좀 더 정교하고 왜곡없는 지리 데이터베이스를 구축할 수 있다(이 역시 번역기 발췌)."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://yeongcheon.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      YeongCheon Blog
    </a>
    <div class="flex-l items-center">
      

      
      









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">S2 library를 이용하여 가까운 위치의 사용자 찾기</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2018-08-05T18:00:00&#43;09:00">August 5, 2018</time>      
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<p>구글에서 제공하는 <a href="http://s2geometry.io/">S2</a> 라이브러리를 이용하여 현재 내 위치에서 가장 가까운 사용자 목록을 추출해보자. 서버 환경은 <a href="https://cloud.google.com/appengine/docs/">GAE</a>, <a href="https://cloud.google.com/appengine/docs/standard/go/">golang standard environment</a> 이다. <a href="https://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/">이 글</a>을 참고했다.</p>

<h2 id="s2-라이브러리란">S2 라이브러리란?</h2>

<p>S2 라이브러리는 구글에서 비공식적으로(<a href="https://github.com/google/s2geometry#disclaimer">not an official</a>) 제공하는 구(球)형상 라이브러리이다(<del>번역기 발췌</del>). 기존의 대다수 라이브러리는 2차원 평면을 기준으로 좌표시스템을 구축하였지만 S2 라이브러리는 3차원 구를 기준으로 좌표계를 사용한다. 실제 지구는 평면보단 구(球)에 훨씬 가깝기 때문에 좀 더 정교하고 왜곡없는 지리 데이터베이스를 구축할 수 있다(<del>이 역시 번역기 발췌</del>).</p>

<p>추가로 <a href="http://geohash.org/">geohash</a>와 비교해보면 도움이 많이 된다.</p>

<h2 id="개발-요구사항">개발 요구사항</h2>

<ol>
<li>사용자의 현재 위치를 위도, 경도 형태로 전달받아 서버에 저장한다.</li>
<li>서버에 저장된 사용자들을 특정 좌표(위도, 경도)에 가장 가까운 순으로 정렬해서 결과값으로 반환한다.</li>
</ol>

<h2 id="제약사항">제약사항</h2>

<ol>
<li>DB는 <a href="https://cloud.google.com/appengine/docs/standard/go/datastore/">datastore</a>를 사용한다(mysql, mariadb, elasticsearch, mongoDB 등등 유명한 DB 사용불가).</li>
<li>InMemory DB는 <a href="https://cloud.google.com/appengine/docs/standard/go/memcache/">Memcache</a>를 사용한다(redis 사용 불가).</li>
<li>서버 인스턴스는 GAE standard 환경 위에서 가동된다(보편적인 서버환경에 비해 제약사항이 꽤 있다).</li>
</ol>

<p>사실 위 제약사항들은 모두 비용을 최소화 하느라 어쩔수 없이 발생한 문제들이다(ㅠㅠ). 살림살이에 여유가 있다면 GCE로 별도 인스턴스를 띄워 <a href="https://stackoverflow.com/questions/4687312/querying-within-longitude-and-latitude-in-mysql">mysql</a>이나 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-distance-query.html">elasticsearch</a>같은 디비를 설치해 쉽게 검색쿼리를 이용할 수 있다.</p>

<h2 id="검색-방법">검색 방법</h2>

<h3 id="위치정보-갱신">위치정보 갱신</h3>

<ol>
<li><strong>과거 위치 삭제</strong> : userID를 key로 사용하여 memcache 아이템을 조회, 값이 있을 경우 해당 아이템에 들어있는 LatLng 값을 사용하여 CellID를 추출, CellID를 key로 사용하여 memcache 아이템을 조회, 본인의 userID를 제거한다.</li>
<li><strong>현재 위치를 userID key를 이용해 저장</strong> : <code>key: userID</code>, <code>value: LatLng</code> 형식의 아이템을 memcache에 셋팅한다.</li>
<li><strong>CellID 추출</strong> : LatLng를 이용해서 Level25의 CellID를 구한다(레벨이 높을수록 Cell 당 범위가 좁아진다. 최대레벨은 30).</li>
<li><strong>CellIdList에 cellId 추가</strong> :  CellID를 <code>key: &quot;cellIdList&quot;</code>, <code>value: []string</code> 아이템에 추가한다. 이 때 []string 배열 안에 이미 내 userId가 들어있을 경우 추가하지 않고 생략한다.</li>
<li><strong>CellID를 key로 사용하여 내 userID 추가</strong> : <code>key: CellID</code>, <code>value: map[string]bool</code> 아이템을 추가한다. Map에는 <code>key: userId</code>, <code>value: true</code> 형식으로 값 추가.</li>
</ol>

<h3 id="조회">조회</h3>

<ol>
<li><strong>기준 좌표의 CellId 추출</strong> :  입력받은 기준값 LatLng를 이용해 Level25짜리 CellID를 추출한다(레벨이 높을수록 Cell 당 범위가 좁아진다. 최대레벨은 30). 이 때 CellID는 위의 위치정보 갱신 로직에서 사용한 레벨과 동일해야 한다.</li>
<li><strong>기준 좌표와 가까운 순으로 모든 CellIdList 추출</strong> :  cellIdList에 있는 CellIdNumber와 기준값과의 차이를 절댓값으로 구한 뒤 오름차순으로 정렬한다(이 차이가 적을수록 가깝다고 판단하는데 맞는지 모르겠다).</li>
<li><strong>cellId에 속해있는 사용자 Id 추출</strong> : 정렬된 순서대로 cellId 추출해서 key: CellID, value: map[string]bool 아이템을 조회, 유저 아이디 목록을 뽑는다.</li>
<li><strong>사용자 상세정보 조회</strong> : 유저 아이디를 key로 사용해서 datastore에서 사용자 정보를 조회, 목록으로 만들어 반환한다.</li>
</ol>

<h2 id="code">Code</h2>

<pre><code class="language-golang">
func (usersBiz *UsersBiz) GetUserList(ctx context.Context, userId string, latitude, longtitude float64, page int) (interface{}, error) {
	userDao := usersBiz.UserDao

	guidePoint := s2.LatLngFromDegrees(latitude, longtitude)
	guideCellID := s2.CellIDFromLatLng(guidePoint)

	customCache := customMemcache.Memcache{
		Context: ctx,
	}

	var userResponseList []models.UserResponse
	if page == 1 {
		cellIDs := customCache.GetCellIdList()
		similarList := make([]map[string]interface{}, len(cellIDs))

		for idx, cellID := range cellIDs {
			similarMap := make(map[string]interface{})

			cellIdNumber := uint64(cellID)
			guideCellNumber := uint64(guideCellID)

			similarMap[&quot;cellID&quot;] = cellID
			similarMap[&quot;diffPoint&quot;] = math.Abs(float64(cellIdNumber - guideCellNumber))

			similarList[idx] = similarMap
		}

		sort.Slice(similarList, func(i, j int) bool {
			return similarList[i][&quot;diffPoint&quot;].(float64) &gt; similarList[j][&quot;diffPoint&quot;].(float64)
		})

		userIdList := make([]string, 0)
		for _, similarMap := range similarList {
			cellID := similarMap[&quot;cellID&quot;].(s2.CellID)

			userMap, err := customCache.GetUserMapInCell(cellID)
			if err != nil {
				log.Errorf(ctx, &quot;%s&quot;, err)
			}

			for userId, _ := range userMap {
				if !util.IsContains(userIdList, userId) {
					userIdList = append(userIdList, userId)
				}
			}
		}

		if len(userIdList) == 0 {
			return make([]interface{}, 0), nil
		}

		userList, err := userDao.GetUserList(ctx, userIdList)
		if err != nil {
			log.Errorf(ctx, &quot;%s&quot;, err)
		}

		userResponseList = convertUserListToUserResponseList(ctx, userDao, &amp;guidePoint, userList, userId)

		sort.Slice(userResponseList, func(i, j int) bool {
			return userResponseList[i].Distance &lt; userResponseList[j].Distance
		})

		customCache.UpdateNearestUserList(userId, userResponseList)
	} else {
		personalData, _ := customCache.GetPersonalData(userId)
		userResponseList = personalData.NearestUserResponseList
	}

	if len(userResponseList) &lt;= 0 {
		return models.ERR_NO_CONTENT, nil
	}

	var startIndex int
	var endIndex int

	startIndex = (page - 1) * 20
	if page*20 &gt; len(userResponseList) {
		endIndex = len(userResponseList)
	} else {
		endIndex = page * 20
	}

	if startIndex &gt; endIndex {
		return models.ERR_NO_CONTENT, nil
	}

	userResponseList = userResponseList[startIndex:endIndex]

	return userResponseList, nil
}

</code></pre>

<p>로직도 엉성하고 코드도 엉성하다. <a href="mailto:kyc1682@gmail.com">개선점, 피드백은 언제나 환영</a>.</p>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://yeongcheon.github.io/" >
    &copy; 2019 YeongCheon Blog
  </a>
    <div>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
