<!doctype html><html lang=ko><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><title>Cloud Functions로 실시간 이미지 리사이징 하기 - 김영천 블로그</title><meta property="og:title" content="Cloud Functions로 실시간 이미지 리사이징 하기 - 김영천 블로그"><meta name=twitter:title content="Cloud Functions로 실시간 이미지 리사이징 하기 - 김영천 블로그"><meta name=description content="Cloud Functions을 이용해서 On-The-Fly 이미지 리사이징 및 포맷 변경을 해봅시다."><meta property="og:description" content="Cloud Functions을 이용해서 On-The-Fly 이미지 리사이징 및 포맷 변경을 해봅시다."><meta name=twitter:description content="Cloud Functions을 이용해서 On-The-Fly 이미지 리사이징 및 포맷 변경을 해봅시다."><meta name=author content="YeongCheon Kim"><meta property="og:site_name" content="김영천 블로그"><meta property="og:url" content="https://yeongcheon.github.io/posts/2021-01-06-image-resize-cloud-function/"><meta property="og:type" content="article"><meta property="og:image" content="https://yeongcheon.github.io/images/profile_no_background.png"><meta name=twitter:image content="https://yeongcheon.github.io/images/profile_no_background.png"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.85.0"><link rel=stylesheet href=/css/style.css media=all><link rel=stylesheet href=/css/syntax.css media=all><link rel=stylesheet href=/css/custom.css media=all><script src=/js/script.js></script><script src=/js/custom.js></script><script defer src=/js/fontawesome.js></script></head><body><header class=site-header><nav class=site-navi><h1 class=site-title><a href=/><img src=/images/profile_no_background.png>김영천 블로그 - 게을러지고 싶으면 공부해야 합니다.</a></h1><ul class=site-navi-items><li class=site-navi-item-tags><a href=/tags/ title=Tags>Tags</a></li><li class=site-navi-item-archives><a href=/posts/ title=Archives>Archives</a></li><li class=site-navi-item-about><a href=/about/ title=About>About</a></li></ul></nav></header><hr class=site-header-bottom><div class=main role=main><article class=article><h1 class=article-title>Cloud Functions로 실시간 이미지 리사이징 하기</h1><h2 class=article-subtitle>Cloud Functions을 이용해서 On-The-Fly 이미지 리사이징 및 포맷 변경을 해봅시다.</h2><hr class=article-title-bottom><ul class=article-meta><li class=article-meta-date><time>January 6, 2021</time></li><li class=article-meta-tags><a href=/tags/gcp/><i class="fas fa-tag"></i>
gcp
</a>&nbsp;</li><li class=article-meta-tags><a href=/tags/cloudfunctions/><i class="fas fa-tag"></i>
cloudfunctions
</a>&nbsp;</li><li class=article-meta-tags><a href=/tags/on-the-fly/><i class="fas fa-tag"></i>
on-the-fly
</a>&nbsp;</li></ul><p><a href=https://medium.com/daangn/lambda-edge%EB%A1%9C-%EA%B5%AC%ED%98%84%ED%95%98%EB%8A%94-on-the-fly-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95-f4e5052d49f3>당근마켓</a>, <a href=http://engineering.vcnc.co.kr/2016/05/ondemand-image-resizing/>비트윈</a> 등에서 작성한 글을 참고하여 GCP 기반으로 비슷한 기능을 하는 코드를 작성하여 봅시다. 동작 원리는 앞서 말한 글에 자세히 나와있으니 서론은 생략하고 바로 시작합니다.</p><p>이 문서에서는 GCP의 아래 제품들을 사용합니다.</p><ul><li><p><a href="https://cloud.google.com/functions/docs?hl=ko">Cloud Functions</a></p></li><li><p><a href="https://cloud.google.com/storage?hl=ko">Cloud Stroage</a></p></li><li><p><a href="https://cloud.google.com/cdn/docs/using-cdn?hl=ko">Cloud CDN</a></p></li></ul><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Cloud Storage</h2><div id=outline-text-headline-1 class=outline-text-2><p>실제 이미지들이 저장될 storage bucket을 생성해야 합니다. 여기선 특별할게 없으니 <a href="https://cloud.google.com/storage/docs/creating-buckets?hl=ko">공식 가이드</a>로 대체합니다.</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Cloud Functions</h2><div id=outline-text-headline-2 class=outline-text-2><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>코드 수정 및 배포</h3><div id=outline-text-headline-3 class=outline-text-3><p>Cloud Function을 호출하는 방법은 여러가지가 있습니다만 이 문서에서는 http 요청을 통해 호출하는 방법을 사용합니다. Cloud Functions에 배포할 코드는 <a href=https://github.com/YeongCheon/imagick-cf>여기</a>에 있습니다. 프로젝트를 받으신 후 소스코드(<a href=https://github.com/YeongCheon/imagick-cf/blob/a311deffdb085cb277d7fbfbf78006958d0145a5/main.go#L32>32번 라인</a>)에서 BUCKET_NAME을 이전 단계에서 생성한 실제 버킷 이름으로 교체해야 합니다. 버킷명 수정 후 프로젝트 루트 폴더에서 아래의 명령어를 실행해서 코드를 배포합니다. 이 명령어를 통해 배포하면 인증되지 않은 사용자도 http 요청을 통해서 함수를 호출할 수 있습니다.</p><div class="src src-bashㅍ"><pre><code class=language-bashㅍ data-lang=bashㅍ>gcloud functions deploy OptimizeImage \
 --runtime go113 \
 --trigger-http \
 --region asia-northeast3 \
 --allow-unauthenticated</code></pre></div><p>배포가 성공하면 콘솔창(<a href=https://console.cloud.google.com/functions/list)>https://console.cloud.google.com/functions/list)</a>에서 아래와 같이 배포된 내역을 확인할 수 있습니다.</p><p><img src="/images/Screenshot from 2021-01-11 22-21-04.png" alt="/images/Screenshot from 2021-01-11 22-21-04.png" title="/images/Screenshot from 2021-01-11 22-21-04.png"></p></div></div><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>트리거 실행</h3><div id=outline-text-headline-4 class=outline-text-3><p>콘솔창에서 해당 함수 이름을 클릭하면 트리거 탭이 있습니다. 트리거 탭에 접근하면 아래와 같이 트리거 URL을 확인할 수 있습니다.</p><p><img src="/images/2021-01-11 22-38-12.jpg" alt="/images/2021-01-11 22-38-12.jpg" title="/images/2021-01-11 22-38-12.jpg"></p><p>표시된 URL 뒤에 접근할 이미지 이름과 원하는 이미지 포맷, 사이즈 등등을 입력하면 결과를 확인할 수 있습니다(예시 URL: <a href="https://asia-northeast3-PROJECT-NAME.cloudfunctions.net/OptimizeImage/IMAGE_NAME.jpg?format=webp&width=1024).">https://asia-northeast3-PROJECT-NAME.cloudfunctions.net/OptimizeImage/IMAGE_NAME.jpg?format=webp&width=1024).</a></p></div></div></div></div><div id=outline-container-headline-5 class=outline-2><h2 id=headline-5>Cloud CDN</h2><div id=outline-text-headline-5 class=outline-text-2><p>cloud function이 정상적으로 동작하는 게 확인됐으면 이제 Cloud CDN에 생성한 function을 연결할 차례입니다. 이것도 별거 없으므로 <a href="https://cloud.google.com/cdn/docs/setting-up-cdn-with-serverless?hl=ko">공식 가이드</a>로 대체합니다.</p><p>이상입니다.</p></div></div></article><div class=disqus-comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//yeongcheon.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><ul class="pager article-pager"><li class=pager-newer><a href=/posts/2021-01-26-emacs-typescript-eslint-setting/ data-toggle=tooltip data-placement=top title="emacs에서 Typescript 개발환경 구축하기">&lt; Newer</a></li><li class=pager-older><a href=/posts/2020-11-26-html-download-property/ data-toggle=tooltip data-placement=top title="HTML의 download 속성">Older ></a></li></ul></div><div class=site-footer><div class=copyright>&copy; Copyright 2020 YeongCheon</div><ul class=site-footer-items><li class=site-footer-item-about><a href=/about/ title=About>About</a></li></ul><div class=powerdby>Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/taikii/whiteplain>Whiteplain</a></div></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-135478508-1','auto'),ga('send','pageview'))</script></body><script data-ad-client=ca-pub-4599234083355765 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></html>