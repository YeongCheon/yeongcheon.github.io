<!doctype html><html lang=ko><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>cloud function 호출 시 context의 중요성에 대해 알아보자. - 김영천 블로그</title><meta name=Description content="게을러지고 싶으면 공부해야 합니다."><meta property="og:title" content="cloud function 호출 시 context의 중요성에 대해 알아보자."><meta property="og:description" content="예전 글에서 언급한 imagick-cf를 테스트 하는 도중 마주한 알 수 없는 특이한 오류와 이를 해결했던 과정을 기록합니다. 문제 url을 통해서 함수를 실행하면"><meta property="og:type" content="article"><meta property="og:url" content="https://yeongcheon.github.io/posts/2021-02-05-cloud-function-context-problem/"><meta property="og:image" content="https://yeongcheon.github.io/images/profile_no_background.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-05T18:51:12+09:00"><meta property="og:site_name" content="김영천 블로그"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yeongcheon.github.io/images/profile_no_background.png"><meta name=twitter:title content="cloud function 호출 시 context의 중요성에 대해 알아보자."><meta name=twitter:description content="예전 글에서 언급한 imagick-cf를 테스트 하는 도중 마주한 알 수 없는 특이한 오류와 이를 해결했던 과정을 기록합니다. 문제 url을 통해서 함수를 실행하면"><meta name=application-name content="김영천 블로그"><meta name=apple-mobile-web-app-title content="김영천 블로그"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yeongcheon.github.io/posts/2021-02-05-cloud-function-context-problem/><link rel=prev href=https://yeongcheon.github.io/posts/2021-02-03-fix-git-hooks-not-working/><link rel=next href=https://yeongcheon.github.io/posts/2021-05-07-covid-visitor-list/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"cloud function 호출 시 context의 중요성에 대해 알아보자.","inLanguage":"ko","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yeongcheon.github.io\/posts\/2021-02-05-cloud-function-context-problem\/"},"genre":"posts","keywords":"gcp, cloudfunction, golang, context","wordcount":1375,"url":"https:\/\/yeongcheon.github.io\/posts\/2021-02-05-cloud-function-context-problem\/","datePublished":"2021-02-05T00:00:00+00:00","dateModified":"2021-02-05T18:51:12+09:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"yeongcheon"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="김영천 블로그"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/profile_no_background.png data-srcset="/images/profile_no_background.png, /images/profile_no_background.png 1.5x, /images/profile_no_background.png 2x" data-sizes=auto alt=/images/profile_no_background.png title=/images/profile_no_background.png>김영천 블로그<span class=header-title-post><sup>"게을러지고 싶으면 공부해야 합니다."</sup></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="테마 변경">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="김영천 블로그"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/profile_no_background.png data-srcset="/images/profile_no_background.png, /images/profile_no_background.png 1.5x, /images/profile_no_background.png 2x" data-sizes=auto alt=/images/profile_no_background.png title=/images/profile_no_background.png>김영천 블로그<span class=header-title-post><sup>"게을러지고 싶으면 공부해야 합니다."</sup></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="테마 변경">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>목차</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">cloud function 호출 시 context의 중요성에 대해 알아보자.</h1><h2 class=single-subtitle>cloud function을 http trigger로 호출 시 context를 잘못 할당할 경우 발생하는 문제에 대해 알아봅시다.</h2><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/yeongcheon title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>yeongcheon</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-02-05>2021-02-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1375 단어&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;읽는데 약 3분&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>목차</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#headline-1>문제</a></li><li><a href=#headline-2>원인 추측</a></li><li><a href=#headline-3>대응</a><ul><li><a href=#headline-4>Wrong code</a></li><li><a href=#headline-5>Good Code</a></li></ul></li><li><a href=#headline-6>결론</a></li></ul></nav></div></div><div class=content id=content><p><a href=/posts/2021-01-06-image-resize-cloud-function.html>예전 글</a>에서 언급한 <a href=https://github.com/YeongCheon/imagick-cf>imagick-cf</a>를 테스트 하는 도중 마주한 알 수 없는 특이한 오류와 이를 해결했던 과정을 기록합니다.</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>문제</h2><div id=outline-text-headline-1 class=outline-text-2><ol><li>url을 통해서 함수를 실행하면 최초 실행 후 일정 시간동안은 몇번을 호출하든 결과가 정상적으로 반환합니다.</li><li>하지만 이후 500 에러를 반환하기 시작합니다. 심지어 이 전에 정상적으로 반환했던 url을 그대로 호출해도 500 error를 반환하는 어처구니 없는 모습을 보여줍니다.</li><li>게다가 500 에러를 반환하는 경우엔 로그조차 남지 않아서 원인을 지레짐작으로 파악할 수 밖에 없는 상황입니다.</li><li>물론 local test시에는 매우 잘 동작합니다.</li></ol><p>절망하다가 차츰 화가 나기 시작합니다.</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>원인 추측</h2><div id=outline-text-headline-2 class=outline-text-2><p>처음에는 에러가 무작위로 발생한다고 생각했지만 여러번의 테스트를 해본 결과, <strong>함수 배포 후 첫 호출 이후 60초 동안은 파라메터가 잘못되지 않는 이상 절대 에러가 발생하지 않았습니다.</strong> 이 <strong>60초</strong> 라는 시간이 대체 어디서 나온 녀석인지 알아보기 위해서 클라우드 콘솔 화면을 여기저기 뒤적이다가 다음과 같은 화면을 발견했습니다.</p><p><img src=/images/2021-02-05-cloud-function-context-problem-cloudfunction-setting.jpg alt=/images/2021-02-05-cloud-function-context-problem-cloudfunction-setting.jpg title=/images/2021-02-05-cloud-function-context-problem-cloudfunction-setting.jpg></p><p>60초라는 키워드가 등장하는 제한 시간 옵션입니다. 개발자가 별도로 설정하지 않는다면 기본값으로 60초가 할당되는데 문제가 발생하는 기준인 최초 호출 이후 60초라는 제한 시간이 여기서 나왔다고 추측했습니다. 이후 이 값을 10초로 수정 후 테스트를 진행했더니 실제로 10초 뒤에 동일한 에러가 발생하였습니다.</p><p>물론 이 사실을 안다고 해서 버그를 수정하는데 직접적으로 도움이 되는건 아니지만 개발자의 직감에 도움이 됩니다. 함수 제한 시간과 관련이 있단 사실을 알고나니 갑자기 <a href=https://golang.org/pkg/context/>context</a>가 원인이지 않을까 싶어서 관련 코드를 좀 살펴보았고, <strong>결과부터 말하자면 context 관련 문제가 맞았습니다.</strong></p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>대응</h2><div id=outline-text-headline-3 class=outline-text-2><p>이제 실제 코드를 살펴봅시다. imagick-cf에서 context 관련 버그를 수정한 커밋은 <a href=https://github.com/YeongCheon/imagick-cf/commit/706a9cd35a617e35fd3db2c156024e508f620188>여기</a>입니다. 어떻게 수정했는지는 커밋내역을 살펴보시고 여기서는 간략하게 일부분만 떼어서 살펴보겠습니다.</p><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>Wrong code</h3><div id=outline-text-headline-4 class=outline-text-3><div class="src src-go"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>OptimizeImage</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>originalImage</span> <span class=o>:=</span> <span class=nx>bucket</span><span class=p>.</span><span class=nf>Object</span><span class=p>(</span><span class=nx>imageName</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>originalImageReader</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>originalImage</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span> <span class=c1>// we have problem.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div><p><a href="https://cloud.google.com/functions/docs/concepts/go-runtime?hl=ko#contextcontext">구글 공식 가이드</a>에서는 http trigger로 함수 호출 시에는 <code>http.Request.Context()</code>, background 실행 시에는 <code>context.Background()</code> 를 사용할 것을 권고하고 있습니다. 하지만 OptimizeImage 함수는 cloud function에서 http trigger로 동작하는 함수임에도 <code>context.Background()</code> 를 사용하고 있었습니다. 그럼 이제 구글이 하라는대로 코드를 고쳐봅시다.</p></div></div><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>Good Code</h3><div id=outline-text-headline-5 class=outline-text-3><div class="src src-go"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>OptimizeImage</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>originalImage</span> <span class=o>:=</span> <span class=nx>bucket</span><span class=p>.</span><span class=nf>Object</span><span class=p>(</span><span class=nx>imageName</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>originalImageReader</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>originalImage</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>())</span> <span class=c1>// good!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div><p>context를 backgroud 대신 request에서 얻어와서 사용하도록 코드를 수정하였습니다. 위에 첨부된 코드 말고도 여러 영역에서 <code>Context.background()</code> 함수를 호출하고 있었기 때문에 관련 부분을 모두 수정해주었습니다. 아, 하지만 무조건 <code>Context.background()</code> 를 사용하지 말라는건 아닙니다. <a href=https://golang.org/doc/effective_go.html#init>func init()</a> 안에서는 request를 통해서 context를 얻는게 불가능하기 때문에 Context.background()를 이용해 context를 사용해도 괜찮습니다.</p></div></div></div></div><div id=outline-container-headline-6 class=outline-2><h2 id=headline-6>결론</h2><div id=outline-text-headline-6 class=outline-text-2><p>직접 띄우는 서버가 아니라 cloud function에서 가볍게 돌아갈 코드라고 너무 대충 작성한 제 과오를 반성합니다. 실제 클라우드 환경에서만, 그것도 로그가 안남는 버그가 발생해서 많이 당황했지만 그래도 아무생각 없이 대충 써왔던 context에 대해서 다시 한번 신경쓰는 계기가 되는 경험이었습니다. 문제를 해결하고 보니 다른 언어를 사용했으면 이런 context 관련 문제는 마주치지 않아도 되지 않았을까 생각했지만 그래도 golang은 여전히 저한테는 매력적인 언어입니다. 언어를 탓하지 않고 제가 짠 코드를 탓하는게 맞겠지요. 아무튼 재미있는 경험이었습니다.</p><p><strong>한 줄 요약: http trigger로 호출한 함수 안에서는 <code>context.Background()</code> 대신 <code>request.Context()</code> 를 사용합시다.</strong></p></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>수정: 2021-02-05</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/2021-02-05-cloud-function-context-problem/index.md target=_blank>마크다운 읽기</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="공유하기 Twitter" data-sharer=twitter data-url=https://yeongcheon.github.io/posts/2021-02-05-cloud-function-context-problem/ data-title="cloud function 호출 시 context의 중요성에 대해 알아보자." data-hashtags=gcp,cloudfunction,golang,context><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="공유하기 Facebook" data-sharer=facebook data-url=https://yeongcheon.github.io/posts/2021-02-05-cloud-function-context-problem/ data-hashtag=gcp><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="공유하기 Hacker News" data-sharer=hackernews data-url=https://yeongcheon.github.io/posts/2021-02-05-cloud-function-context-problem/ data-title="cloud function 호출 시 context의 중요성에 대해 알아보자."><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="공유하기 Pocket" data-sharer=pocket data-url=https://yeongcheon.github.io/posts/2021-02-05-cloud-function-context-problem/><i class="fab fa-get-pocket fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/gcp/>GCP</a>,&nbsp;<a href=/tags/cloudfunction/>cloudfunction</a>,&nbsp;<a href=/tags/golang/>golang</a>,&nbsp;<a href=/tags/context/>context</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>뒤로</a></span>&nbsp;|&nbsp;<span><a href=/>홈</a></span></section></div><div class=post-nav><a href=/posts/2021-02-03-fix-git-hooks-not-working/ class=prev rel=prev title="git hooks 안되는 문제 해결하기"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>git hooks 안되는 문제 해결하기</a>
<a href=/posts/2021-05-07-covid-visitor-list/ class=next rel=next title="코로나 방문자 수기명부 개인정보 수집제공 동의서 양식">코로나 방문자 수기명부 개인정보 수집제공 동의서 양식<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.103.1">Hugo</a>로 제작된 사이트 | 테마 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/yeongcheon target=_blank>YeongCheon Kim</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="맨 위로"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="댓글 보기"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=https://yeongcheon.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"복사하기",maxShownLines:50},comment:{},cookieconsent:{content:{dismiss:"알겠습니다",link:"더 보기",message:"본 웹사이트는 웹 환경 개선을 위해 쿠키를 사용합니다."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0YT8RHXZR3",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-0YT8RHXZR3" async></script></body></html>