<!doctype html>
<html>
  <head>
    <title>Googlde App Engine(GAE) datastore index 관련 에러 해결하기 // YeongCheon Tech Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.54.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="YeongCheon Kim" />
    <meta name="description" content="" />
    <base href="https://yeongcheon.github.io/" />
    <link rel="stylesheet" href="https://yeongcheon.github.io/css/main.min.3bf813d46763420c83fb33c51950b4fc582483efcfddb34b4e4e8d6b811e3208.css" />
  </head>
  <body>
    <header class="app-header">
      <a href="/"><img class="app-header-avatar" src="./avatar.jpg" /></a>
      <h1>YeongCheon Tech Blog</h1>
      <p>잡탕 웹개발자, 이맥스를 좋아해요</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/yeongcheon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Googlde App Engine(GAE) datastore index 관련 에러 해결하기</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Apr 29, 2018
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          2 min read
        </div></div>
    </header>
    <div class="post-content">
      

<h2 id="들어가며">들어가며</h2>

<p>google app engine을 이용해 REST API를 작성하던 중 발생했던 datastore의 index 관련 이슈와 그 해결법에 대해 기록한다. <a href="https://cloud.google.com/datastore/docs/concepts/indexes">참고</a>, <a href="https://groups.google.com/forum/#!topic/google-appengine-java/zKjWwNjcTsE">여기도 참고</a></p>

<h2 id="에러발생-상황">에러발생 상황</h2>

<p>내 프로필을 조회한 사람들의 목록을 반환해주는 API를 작성했다. 코드는 딱히 별거 없고 그냥 datastore에 있는 데이터들을 불러오는 내용이다. 핵심코드는 아래와 같다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#a6e22e">q</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">datastore</span>.<span style="color:#a6e22e">NewQuery</span>(<span style="color:#a6e22e">userDao</span>.<span style="color:#a6e22e">VisitorEntity</span>).<span style="color:#a6e22e">Filter</span>(<span style="color:#e6db74">&#34;UserId=&#34;</span>, <span style="color:#a6e22e">userId</span>).<span style="color:#a6e22e">Order</span>(<span style="color:#e6db74">&#34;-VisitTime&#34;</span>)</code></pre></div>
<p>UserId 필드의 값을 기준으로 필터링을 하고 VisitTime을 최근순으로 정렬하는 간단한 코드다. 위 쿼리문을 베이스로 한 API는 로컬테스트는 무사히 통과하고 배포까지 정상적으로 완료, 이 후 클라우드에 올라간 API를 테스트 했는데 다음과 같은 에러로그를 내뿜었다.</p>

<pre><code>API error 4 (datastore_v3: NEED_INDEX): no matching index found. recommended index is:
- kind: kindname
  properties:
  - name: fieldName1
  - name: FiendName2
    direction: desc&quot;
</code></pre>

<h2 id="해결방안">해결방안</h2>

<p>위 에러메세지는 배포 명령 실행 시 파라메터를 누락시켰기 때문에 발생하는 메세지이다. 코드 작성 후 로컬 dev_appserver.py 를 이용해 로컬에서 서버를 실행하면 <code>index.yaml</code> 파일이 자동으로 생성된다. 이 파일은 맨 위에 작성된 쿼리문을 바탕으로 <strong>인덱싱 정보들을 담아놓은 파일</strong>인데 deploy 명령어를 쓸 때 직접 명시를 해주어야 한다. 기존에 내가 쓰던 deploy 명령어는 아래와 같다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">gcloud app deploy</code></pre></div>
<p><strong>위 명령어를 이용해 배포하면 제대로 동작하지 않는다.</strong> 아래의 명령어를 살펴보자.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">gcloud app deploy index.yaml</code></pre></div>
<p>위와 같이 자동 생성된 <code>index.yaml</code> 파일을 직접 명시해주지 않으면 배포될 때 서버에 함께 올라가지 않는다.<a href="https://cloud.google.com/sdk/gcloud/reference/app/deploy">공식문서</a>. 공식 문서의 내용을 굳이 설명하자면 depoy 명령어 뒤에 yaml을 명시하지 않으면 기본값으로 app.yaml 파일을 사용한다. <code>index.yaml</code> 파일도 함께 deploy 했다면 이제 API를 다시 호출해보자. 새로운 에러 메세지를 만날 수 있다.</p>

<pre><code>API error 4 (datastore_v3: NEED_INDEX): The index for this query is not ready to serve. See the Datastore Indexes page in the Admin Console.
</code></pre>

<p>일단 해결법부터 말하자면 <strong>그냥 기다리면 된다.</strong> <code>index.yaml</code> 파일의 내용을 기반으로 한 인덱싱 작업이 아직 완료되지 않아서 사용할 수 없다는 내용이다. 클라우드 콘솔 페이지(<a href="https://console.cloud.google.com/datastore/indexes?project=project-name)에">https://console.cloud.google.com/datastore/indexes?project=project-name)에</a> 접근하면 열심히 인덱싱 작업중이라는 메세지가 나온다. 인덱싱 작업에 걸리는 시간은 기준은 정확이 모르지만 필자의 경우 datastore에 데이터가 거의 없고 쿼리내용도 별로 복잡하지 않았는데 약 30분 정도 걸렸다. 구글 검색결과 해외의 어느 유저분은 4시간이 걸렸다고 한다. 자세한 내용은 <a href="https://cloud.google.com/datastore/docs/concepts/indexes">공식 문서</a>를 참고해보자.</p>

<h2 id="수정내용-2018-05-01">수정내용(2018-05-01)</h2>

<p><code>gcloud app deploy index.yaml</code> 명령어로 배포를 할 경우 서버코드는 배포되지 않고 인덱스 설정만 배포된다. 서버코드를 수정하고 배포할 경우 아래의 명령어를 사용해야 한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">gcloud app deploy app.yaml index.yaml</code></pre></div>
<p>인덱스 내용에 변경사항이 없을 경우 <code>index.yaml</code>은 생략해도 된다.</p>

    </div>
  </article>

    </main>
  </body>
</html>
